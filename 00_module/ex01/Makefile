NAME		= megaphone
CXX			= g++
CPPFLAGS	= -Wall -Werror -Wextra -std=c++98
MAKEFLAGS	+= --no-print-directory

OBJ_DIR		= objs

SRCS		= phonebook.cpp \

OBJS		= $(addprefix $(OBJ_DIR)/, $(SRCS:.cpp=.o))

# Farben
OK	= \033[38;5;76m
ERR	= \033[0;38;5;1m
HDR	= \033[1;36m
RST	= \033[0m

# FIXED BOX WIDTH (innenbreite = 46 chars)
# Wenn du breiter willst: mehr "â”€" hier.
TOP_EXEC	= â”Œâ”€[ EXECUTE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
TOP_ALL     = â”Œâ”€[ ALL ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
TOP_PREPARE = â”Œâ”€[ PREPARE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
TOP_COMPILE = â”Œâ”€[ COMPILE ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
TOP_LINK    = â”Œâ”€[ LINK ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
TOP_CLEAN   = â”Œâ”€[ CLEAN ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
TOP_FCLEAN  = â”Œâ”€[ FCLEAN ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
TOP_ERROR   = â”Œâ”€[ ERROR ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
BOT         = â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Innenbreite (muss zu den Linien oben passen!)
# ZÃ¤hle Zeichen zwischen 'â”‚ ' und ' â”‚' -> hier 50-?; wir setzen bewusst 50.
# Wenn du TOP/BOT Ã¤nderst, diese Zahl mit anpassen.
W = 50

.ONESHELL:
SHELL := /bin/sh
.SILENT:

all:
	# Missing-Source-Check
	missing=false
	for src in $(SRCS); do
		if [ ! -f "$$src" ]; then
			printf "\n$(ERR)%s$(RST)\n" "$(TOP_ERROR)"
			printf "$(ERR)â”‚ %-*s â”‚$(RST)\n" 48 "Missing source file: $$src"
			printf "$(ERR)%s$(RST)\n\n" "$(BOT)"
			missing=true
		fi
	done
	if [ "$$missing" = true ]; then exit 1; fi

	if [ -f "$(NAME)" ]; then
		printf "\n$(OK)%s$(RST)\n" "$(TOP_ALL)"
		printf "$(OK)â”‚ %-*s â”‚$(RST)\n" $(W) "âœ” Nothing to do (already built)"
		printf "$(OK)%s$(RST)\n\n" "$(BOT)"
	else
		$(MAKE) $(NAME)
	fi

$(NAME):

	# ASCII ART (vor PREPARE)
	@printf "$(HDR)"
	cat <<'ASCII'
	â €â €â €â €â €â €â €â €â €â €â¡´â â €â¡°â €â €â €â €â €â €â €
	â €â €â €â €â €â €â €â €â¢€â¡Žâ¢€â €â €â â €â €â €â €â €â €â €
	â£€â €â €â €â €â €â €â¡ â ¬â¡¡â ¬â¡‹â €â¡„â €â €â €â €â €â €â €
	â¡€â â ¢â¡€â €â €â¢°â  â¢·â °â †â¡…â €â¡‡â €â €â €â£€â ”â ‚â¡‚
	â ±â¡€â €â ˆâ ’â¢„â¡¸â¡‘â Šâ¢’â£‚â£¦â „â¢ƒâ¢€â ”â ˆâ €â €â¡°â 
	â €â ±â¡€â €â €â¡°â£â£¼â¡¿â¡¿â¢¿â ƒâ  â šâ â €â €â¢€â œâ €â €
	â €â €â â¢„â œâ €â ˆâ “â ’â ˆâ â €â €â €â €â €â¡°â ƒâ €â €â €
	â €â €â¢€â Šâ¡€â €â €â €â €â €â €â €â €â €â €â ¾â¡€â €â €â €â €
	â €â €â¢¸â£„â €â €â¡€â €â €â €â €â €â €â €â €â£€â¡‡â €â €â €
	ASCII
	@printf "$(RST)"

	# PREPARE
	printf "\n$(HDR)%s$(RST)\n" "$(TOP_PREPARE)"
	if [ -d "$(OBJ_DIR)" ]; then
		printf "$(OK)â”‚ %-*s â”‚$(RST)\n" $(W) "ðŸ“ Using: $(OBJ_DIR)/"
	else
		if mkdir -p "$(OBJ_DIR)"; then
			printf "$(OK)â”‚ %-*s â”‚$(RST)\n" $(W) "ðŸ“ Created: $(OBJ_DIR)/"
		else
			printf "$(ERR)â”‚ %-*s â”‚$(RST)\n" $(W) "âœ˜ Failed creating: $(OBJ_DIR)/"
			printf "$(HDR)%s$(RST)\n\n" "$(BOT)"
			exit 1
		fi
	fi
	printf "$(HDR)%s$(RST)\n" "$(BOT)"
	sleep 0.15

	# COMPILE (ein Rahmen, mehrere Zeilen)
	failed=false
	anything=false
	printf "\n$(HDR)%s$(RST)\n" "$(TOP_COMPILE)"
	for src in $(SRCS); do
		obj="$(OBJ_DIR)/$${src%.cpp}.o"
		if [ ! -f "$$obj" ] || [ "$$src" -nt "$$obj" ]; then
			if $(CXX) $(CPPFLAGS) -c "$$src" -o "$$obj"; then
				printf "$(OK)â”‚ %-*s â”‚$(RST)\n" $(W) "âœ” $$obj"
				anything=true
				sleep 0.20
			else
				printf "$(ERR)â”‚ %-*s â”‚$(RST)\n" $(W) "âœ˜ $$src"
				failed=true
				anything=true
				sleep 0.20
			fi
		fi
	done
	if [ "$$anything" = false ]; then
		printf "$(OK)â”‚ %-*s â”‚$(RST)\n" $(W) "âœ” All objects up to date"
	fi
	printf "$(HDR)%s$(RST)\n" "$(BOT)"
	if [ "$$failed" = true ]; then printf "\n"; exit 1; fi
	sleep 0.10

	# LINK
	printf "\n$(HDR)%s$(RST)\n" "$(TOP_LINK)"

	link_output=$$( $(CXX) $(OBJS) -o "$(NAME)" 2>&1 )
	link_status=$$?

	if [ $$link_status -eq 0 ]; then
		printf "$(OK)â”‚ %-*s â”‚$(RST)\n" $(W) "âœ” Compiled: $(NAME)"
		printf "$(HDR)%s$(RST)\n\n" "$(BOT)"
	else
		# WICHTIG: jede Zeile exakt mit "â”‚ <padding> â”‚" (inkl. beider Spaces)
		printf "$(ERR)â”‚ %-*s â”‚$(RST)\n" $(W) "âœ˜ Link failed: $(NAME)"
		printf "$(ERR)â”‚ %-*s â”‚$(RST)\n" 48 ""

		# spezifische Fehler erkennen
		if echo "$$link_output" | grep -q "undefined reference"; then
			missing=$$(echo "$$link_output" | awk -F'`' '/undefined reference/ {print $$2; exit}')
			# optional: trailing ' entfernen
			missing=$$(printf "%s" "$$missing" | sed "s/'$$//")
			printf "$(ERR)â”‚ %-*s â”‚$(RST)\n" 48 "Missing symbol: $$missing"
		fi

		if echo "$$link_output" | grep -q "ld returned"; then
			printf "$(ERR)â”‚ %-*s â”‚$(RST)\n" 48 "Linker aborted build"
		fi

		printf "$(HDR)%s$(RST)\n\n" "$(BOT)"
		exit 1
	fi



RUN_ARGS := $(filter-out run,$(MAKECMDGOALS))

run: $(NAME)
	@printf "\n$(HDR)%s$(RST)\n" "$(TOP_EXEC)"
	@printf "$(OK)â”‚ %-*.*s â”‚$(RST)\n" 48 $(W) "./$(NAME) $(RUN_ARGS)"
	@printf "$(HDR)%s$(RST)\n\n" "$(BOT)"
	@./$(NAME) $(RUN_ARGS)

%:
	@:





clean:
	printf "\n$(HDR)%s$(RST)\n" "$(TOP_CLEAN)"
	if ls $(OBJS) >/dev/null 2>&1; then
		rm -f $(OBJS)
		printf "$(OK)â”‚ %-*s â”‚$(RST)\n" $(W) "âœ” Removed objects from $(OBJ_DIR)/"
	else
		printf "$(ERR)â”‚ %-*s â”‚$(RST)\n" $(W) "â‹— No object files to clean"
	fi
	printf "$(HDR)%s$(RST)\n\n" "$(BOT)"

fclean:
	printf "\n$(HDR)%s$(RST)\n" "$(TOP_FCLEAN)"
	deleted=false
	if ls $(OBJS) >/dev/null 2>&1; then rm -f $(OBJS); deleted=true; fi
	if [ -f "$(NAME)" ]; then rm -f $(NAME); deleted=true; fi
	if [ -d "$(OBJ_DIR)" ]; then rm -rf $(OBJ_DIR); deleted=true; fi
	if [ "$$deleted" = true ]; then
		printf "$(OK)â”‚ %-*s â”‚$(RST)\n" $(W) "âœ” Fully cleaned (objs + bin + dir)"
	else
		printf "$(ERR)â”‚ %-*s â”‚$(RST)\n" $(W) "â‹— Nothing to clean"
	fi
	printf "$(HDR)%s$(RST)\n\n" "$(BOT)"

re: fclean all

.PHONY: all clean fclean re
